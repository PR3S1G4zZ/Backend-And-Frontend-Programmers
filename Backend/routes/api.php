<?php

use App\Http\Controllers\{
    AuthController,
    ProjectController,
    ApplicationController,
    DashboardController,
    AdminController,
    ConversationController,
    DeveloperController,
    ProfileController,
    TaxonomyController,
    PaymentMethodController,
    WalletController,
    FavoriteController,
    ReviewController,
    BackupController
};
use Illuminate\Support\Facades\Route;

/*
|--------------------------------------------------------------------------
| AUTH ROUTES
|--------------------------------------------------------------------------
*/

Route::prefix('auth')->group(function () {

    // Registro y Login
    Route::post('/register', [AuthController::class, 'register'])->middleware('throttle:6,1');
    Route::post('/login',    [AuthController::class, 'login'])->middleware('throttle:6,1');
    
    // Google Auth
    Route::get('/google', [AuthController::class, 'redirectToGoogle']);
    Route::get('/google/callback', [AuthController::class, 'handleGoogleCallback']);

    // recuperar contraseña
    Route::post('/forgot-password', [AuthController::class, 'sendResetLink'])->middleware('throttle:5,1');
    Route::post('/reset-password', [AuthController::class, 'resetPassword'])->middleware('throttle:5,1');

    // Rutas protegidas
    Route::middleware('auth:sanctum')->group(function () {
        Route::post('/logout', [AuthController::class, 'logout']);
        Route::get('/me',      [AuthController::class, 'me']);
        Route::post('/change-password', [AuthController::class, 'changePassword']);
    });
});


/*
|--------------------------------------------------------------------------
| RUTAS PROTEGIDAS (PROYECTOS, APLICACIONES, DASHBOARD)
|--------------------------------------------------------------------------
*/

Route::middleware('auth:sanctum')->group(function () {

    // Projects (solo empresas)
    Route::get('/projects', [ProjectController::class, 'index']);
    Route::post('/projects', [ProjectController::class, 'store']);
    Route::get('/projects/{project}', [ProjectController::class, 'show']);
    Route::put('/projects/{project}', [ProjectController::class, 'update']);
    Route::post('/projects/{project}/fund', [ProjectController::class, 'fund']);
    Route::delete('/projects/{project}', [ProjectController::class, 'destroy']);

    // Aplicaciones (programadores)
    Route::post('/projects/{project}/apply', [ApplicationController::class, 'apply']);
    Route::get('/applications/mine', [ApplicationController::class, 'myApplications']);
    
    // Gestión de Candidatos (Empresa)
    Route::get('/projects/{project}/applications', [ApplicationController::class, 'index']); // Listar candidatos
    Route::post('/applications/{application}/accept', [ApplicationController::class, 'accept']); // Aceptar candidato
    Route::post('/applications/{application}/reject', [ApplicationController::class, 'reject']); // Rechazar candidato

    // Wallet
    Route::get('/wallet', [\App\Http\Controllers\WalletController::class, 'show']);
    Route::post('/wallet/recharge', [\App\Http\Controllers\WalletController::class, 'recharge'])->middleware('throttle:10,1');
    Route::post('/wallet/withdraw', [\App\Http\Controllers\WalletController::class, 'withdraw'])->middleware('throttle:10,1');

    // Dashboards
    Route::get('/dashboard/company', [DashboardController::class, 'company']);
    Route::get('/dashboard/programmer', [DashboardController::class, 'programmer']);

    // Profile
    Route::get('/profile', [ProfileController::class, 'show']);
    Route::match(['put', 'post'], '/profile', [ProfileController::class, 'update']);
    
    // Portfolio Projects
    Route::apiResource('portfolio-projects', \App\Http\Controllers\PortfolioProjectController::class);

    // Taxonomies
    Route::get('/taxonomies/skills', [TaxonomyController::class, 'skills']);
    Route::get('/taxonomies/categories', [TaxonomyController::class, 'categories']);

    // Developers
    Route::get('/developers', [DeveloperController::class, 'index']);
    Route::get('/developers/{id}', [DeveloperController::class, 'show']);

    // Conversations
    Route::get('/conversations', [ConversationController::class, 'index']);
    Route::post('/conversations', [ConversationController::class, 'store']); // Create conversation
    Route::get('/conversations/{conversation}/messages', [ConversationController::class, 'messages']);
    Route::post('/conversations/{conversation}/messages', [ConversationController::class, 'storeMessage']);

    // Favorites
    Route::get('/favorites', [FavoriteController::class, 'index']);
    Route::post('/favorites', [FavoriteController::class, 'store']); // Toggle favorite

    // Reviews
    Route::get('/reviews', [ReviewController::class, 'index']);
    Route::post('/reviews', [ReviewController::class, 'store']);
    Route::get('/reviews/{id}', [ReviewController::class, 'show']);

    // Company projects
    Route::get('/company/projects', [ProjectController::class, 'companyProjects']);

    // Admin routes (solo administradores)
    Route::prefix('admin')->middleware('admin')->group(function () {
        Route::post('/users', [AdminController::class, 'createUser']);
        Route::get('/users', [AdminController::class, 'getUsers']);
        Route::get('/users/stats', [AdminController::class, 'getUserStats']);
        Route::get('/users/{id}', [AdminController::class, 'getUser']);
        Route::put('/users/{id}', [AdminController::class, 'updateUser']);
        Route::delete('/users/{id}', [AdminController::class, 'deleteUser']);
        Route::post('/users/{id}/restore', [AdminController::class, 'restoreUser']);
        Route::post('/users/{id}/ban', [AdminController::class, 'banUser']);
        
        // Admin Projects
        Route::get('/projects', [AdminController::class, 'getProjects']);
        Route::put('/projects/{id}', [AdminController::class, 'updateProject']);
        Route::delete('/projects/{id}', [AdminController::class, 'deleteProject']);
        Route::post('/projects/{id}/restore', [AdminController::class, 'restoreProject']);

        Route::get('/metrics', [AdminController::class, 'metrics']);

        // Categories Management
        Route::apiResource('categories', \App\Http\Controllers\CategoryController::class)->except(['index', 'show']);

        // System Settings & Logs
        Route::get('/system/settings', [\App\Http\Controllers\SettingsController::class, 'getSystemSettings']);
        Route::put('/system/settings', [\App\Http\Controllers\SettingsController::class, 'updateSystemSettings']);
        Route::get('/system/logs', [\App\Http\Controllers\SettingsController::class, 'getActivityLogs']);

        // Database Backups
        Route::prefix('backups')->group(function () {
            Route::get('/', [BackupController::class, 'index']);
            Route::post('/create', [BackupController::class, 'create']);
            Route::post('/restore', [BackupController::class, 'restore']);
            Route::get('/download/{filename}', [BackupController::class, 'download']);
        });
    });

    // Milestones
    Route::get('/projects/{project}/milestones', [\App\Http\Controllers\MilestoneController::class, 'index']);
    Route::post('/projects/{project}/milestones', [\App\Http\Controllers\MilestoneController::class, 'store']);
    Route::put('/projects/{project}/milestones/{milestone}', [\App\Http\Controllers\MilestoneController::class, 'update']);
    Route::delete('/projects/{project}/milestones/{milestone}', [\App\Http\Controllers\MilestoneController::class, 'destroy']);
    Route::post('/projects/{project}/milestones/{milestone}/submit', [\App\Http\Controllers\MilestoneController::class, 'submit']);
    Route::post('/projects/{project}/milestones/{milestone}/approve', [\App\Http\Controllers\MilestoneController::class, 'approve']);
    Route::post('/projects/{project}/milestones/{milestone}/reject', [\App\Http\Controllers\MilestoneController::class, 'reject']);


    // Payment Methods
    Route::get('/payment-methods', [PaymentMethodController::class, 'index']);
    Route::post('/payment-methods', [PaymentMethodController::class, 'store'])->middleware('throttle:10,1');
    Route::put('/payment-methods/{paymentMethod}', [PaymentMethodController::class, 'update']);
    Route::delete('/payment-methods/{paymentMethod}', [PaymentMethodController::class, 'destroy']);

    // --- Settings & Preferences ---
    Route::get('/preferences', [\App\Http\Controllers\SettingsController::class, 'getPreferences']);
    Route::put('/preferences', [\App\Http\Controllers\SettingsController::class, 'updatePreferences']);
    
});
